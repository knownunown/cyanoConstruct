<!--cyano thing-->

<!DOCTYPE html>
<html>
<head>
<title>Cyano'Construct | Assemble Sequence</title>

<link rel = "stylesheet" type = "text/css" href = "{{ url_for('static',filename='styles/style.css') }}">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> 
<script>
var count = 1;

var submitted = false;

var seqElements = ["Pr", "RBS", "GOI", "Term"];

var elemOptions = {{ availableElements|tojson }}; //all the available elements, sorted by type

var compPos = {{ componentsPosition|tojson }}; //all the available components, sorted by position

var validTerminals = {{ validTerminals|tojson }}; //all the valid terminals, sorted by type

var fidelityLimits = {{ fidelityLimits|tojson }};

var currFidLimit;

function inArray(elem, array){
	for(arrayElement of array){
		if(arrayElement == elem){
			return true;
		}
	}
	return false;
}

//format element divs
function formatElements(){ //just get a thing for the seqElements
	var retString = "<select class = 'formField' name = 'elemType" + count + "' id = 'elemType" + count + "' onchange = 'updateForm(this)'>";
	for(seqElem of seqElements){
		retString += "<option value = '" + seqElem + "'>" + seqElem + "</option>"; //need an id?
	}
	retString += "</select>";
	return retString;
}

function formatOptions(elementToUse, idNumber = count){ //get a thing for the lower down stuff
	var retString = "<select class = 'formField' name = 'elemName" + idNumber + "' id = 'elemName" + idNumber + "'>";
	for(option of elemOptions[elementToUse]){
		var idString = idNumber.toString();
		if(inArray(idNumber, compPos[option])){
			retString += "<option value = '" + option + "'>" + option + "</option>"; //id?			
		}
		else{
			retString += "<option value = '" + option + "' disabled>" + option + "</option>"
		}
	}
	retString += "</select>";
	return retString;
}

function formatSection(){
	var format = "<div class = 'elemDiv'>"; //div
	format += "<p class = 'elemName'>Element " + count + "</p>";
	//first select
	format += "<label for = 'elemType" + count + "'>Type</label>";
	format += "<div>";
	format += formatElements();
	format += "</div>";
	//second select
	format += "<label for = 'elemName" + count + "'>Name</label>";
	format += "<div>";
	format += formatOptions("Pr"); //idk man
	format += "</div></div>";
	count += 1;
	return format;
}

function updateForm(selectSeq){
	//get all nodes
	var newValue = selectSeq.value;
	var bigDiv = selectSeq.parentNode.parentNode;
	var secondDiv = bigDiv.lastChild;
	var oldNode = secondDiv.lastChild;

	//get number for the name of the new form
	var oldName = selectSeq.name;
	var oldNumber = Number(oldName.substr(8)); //extract the number of the element

	//create new form as a node
	var newNode = document.createElement("div");
	newNode.innerHTML = formatOptions(newValue, oldNumber);
	
	//replace the old node
	secondDiv.replaceChild(newNode, oldNode);
}

//alter elements
function validateAddElem(){
	var currFidelity = document.getElementById("fidelity").value; //probably could store it somewhere else
	var maxAllowed = fidelityLimits[currFidelity];					//will want to update it when changing fidelity upwards too, actually
	if(maxAllowed < count){
		$("#elementError").text("Can't have more than " + maxAllowed.toString() + " elements at current fidelity.");
		return false;
	}
	else{
		return true;
	}
}

function addElem(){
	if(validateAddElem()){
		$("#elements").append(formatSection());
		$("#elementError").text("");		
	}
}

function rmLastElem(){
	if (document.getElementsByClassName("elemDiv").length > 0){
		var lastChild = document.getElementById("elements").lastChild;
		document.getElementById("elements").removeChild(lastChild);

		count -= 1;
	}
	else {
		$("#elementError").text("No elements to remove.");
	}
}

//submitForm and validate
function submitForm(allData){
	$.ajax({
		data : {bigData: allData},
		type : 'POST',
		url : '/process2'
		})
	.done(function(data){
		var newNode = document.createElement("p");
		newNode.innerHTML = data.output;

		var showOutput = document.getElementById("showOutput");
		var oldChild = document.getElementById("outputParagraph");

		newNode.id = "outputParagraph";

		showOutput.replaceChild(newNode, oldChild);
	});
	event.preventDefault();

	return 0;
}

function validate(){
	var retValue = true;

	//check number of elements
	if(document.getElementsByClassName("elemDiv").length == 2){
		$("#elementError").text("No elements.");
		retValue = false;
		return false;
	}
	else{
		$("#downloadMessage").text("");
		$("#elementError").text("");
	}

	//check number of elements vs fidelity
	if(count - 1 > currFidLimit){
		retValue = false;
	}

	//check if terminal is valid
	var termTypeStr = "elemType" + (count - 1);
	var termTypeVal = document.getElementById(termTypeStr).value;

	var termNameStr = "elemName" + (count - 1);
	var termNameVal = document.getElementById(termNameStr).value;

	var isValidTerm = false;
	for(name of validTerminals[termTypeVal]){
		if(name == termNameVal){
			isValidTerm = true;
			break;
		}
	}

	if(!isValidTerm){
		var errorStr = "There is no " + termTypeVal + " " + termNameVal + " component that can be the terminal.";
		$("#elementError").text(errorStr);
		retValue = false;
		//return false;
	}

	//check values of elements & make allData
	var allFields = document.getElementsByClassName("formField");

	var allData = "{";
	for (i = 0; i < allFields.length; i++){

		if(allFields[i].value == ""){
			$("#elementError").text("Not all elements have values.");
			retValue = false;
			break;		
		}

		var name = allFields[i].name; //key: name
		allData += "'" + name + "': "; //: is toString necessary?
		var value = allFields[i].value; //value: value
		allData += "'" + value + "'";

		if(i < allFields.length - 1){ //,
			allData += ", ";
		}
	}
	allData += "}";

	//submit
	if(retValue){
		submitForm(allData);
		submitted = true;
	}

	return retValue;
}

//download file
function downloadFile(){
	if(submitted){
		$("#downloadMessage").text("Preparing files...");
		window.location.href = "/sequencesZip2.zip";
		event.preventDefault();
		$("#downloadMessage").text("Downloaded.");
	}
	else{
		$("#downloadMessage").text("No sequence submitted.");
	}
}

//
function fidelityChanged(){
	//great
	var fidelitySelect = document.getElementById("fidelity");

	currFidLimit = fidelityLimits[fidelitySelect.value];

	if(count - 1 > currFidLimit){
		$("#elementError").text("Can't have more than " + currFidLimit + " elements at current fidelity.");
	}
}

</script>
</head>
<body>

<a href = "/domesticate">Domesticate</a> <a href = "/assemble">Assemble</a> <a href = "/components">Components</a>

<div id = "inputCol"><div id = "input">
	<form id = "form" method = "POST" onsubmit = "validate(); return false;">
		<div>
			<h3>Input</h3>

			<div id = "fidelityInput">
				<label for = "fidelity">Spacer Fidelity</label>
				<div class = "shouldGrow"></div>
				<select class = "formField" name = "fidelity" id = "fidelity" onload = "fidelityChanged()" onchange = "fidelityChanged()">
					{% for num in fidelities %}
						<option value = "{{ num }}">{{ num }}</option>
					{% endfor %}
				</select>
			</div>

			<p>No melting point input at this step?</p>

			<h3>Sequence</h3>
		</div>


		<div class="elemDiv">
			<p class="elemName">Element 0</p>
			<label for="elemType0">Type</label>
			<div><select class="formField" name="elemType0" id="elemType0"><option value="Pr">Pr</option></select></div>
			<label for="elemName0">Name</label>
			<div><select class="formField" name="elemName0" id="elemName0"><option value="psbA">psbA</option></select></div>
		</div>

		<div id = "elements">
		</div>

		<div class="elemDiv">
			<p class="elemName">Element T</p>
			<label for="elemType999">Type</label>
			<div><select class="formField" name="elemType999" id="elemType999"><option value="Term">Term</option></select></div>
			<label for="elemName999">Name</label>
			<div><select class="formField" name="elemName999" id="elemName999"><option value="T1">T1</option></select></div>
		</div>


		<div>
			<span class = "errorMessage" id = "elementError"></span>
			<br>
			<button name = "newElement" type = "button" onclick = "addElem()">New Element</button>
			<button name = "rmElement" type = "button" onclick = "rmLastElem()">Remove Last Element</button>
			<hr>

			<button type = "submit" id = "threeSubmit">Submit</button>
		</div>
	</form>
</div></div>

<div id = "outputCol"><div id = "output">
	<h3>Output</h3>
	<div id = "showOutput"><p id = "outputParagraph">
		All elements (names) possible: <br>
		{{ availableElements }}
		<br>All elements (names) & allowed positions: <br>
		{{ componentsPosition }}
		<br>All allowed terminal components: <br>
		{{ validTerminals }}
	</p></div>
	<hr style = "width: 100%">
	<div>
		<button type = "button" onclick = "downloadFile()">Download .fasta files as .zip</button>
		<span id = "downloadMessage"></span>
	</div>
</div></div>

</body>
</html>